name: Build, Push and Deploy (service-a)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

jobs:
  # ───────────────────────────────
  # 1) CI: 이미지 빌드 & GHCR 푸시
  # ───────────────────────────────
  build-and-push:
    runs-on: ubuntu-latest

    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository_owner }}/service-a

    outputs:
      image_sha: ${{ steps.set-vars.outputs.IMAGE_SHA }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build JAR with Gradle
        run: ./gradlew clean bootJar

      - name: Login to GHCR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${GITHUB_TOKEN}" | docker login $REGISTRY -u "${{ github.actor }}" --password-stdin

      # 이미지 태그 계산 (SHA 태그)
      - name: Set image tags
        id: set-vars
        run: |
          IMAGE_SHA=${REGISTRY}/${IMAGE_NAME}:${GITHUB_SHA}
          echo "IMAGE_SHA=$IMAGE_SHA" >> "$GITHUB_OUTPUT"

      - name: Build & Push Docker image
        run: |
          IMAGE_SHA=${{ steps.set-vars.outputs.IMAGE_SHA }}
          IMAGE_LATEST=${REGISTRY}/${IMAGE_NAME}:main

          echo "Build image: $IMAGE_SHA"
          docker build -t "$IMAGE_SHA" .

          echo "Tag as main"
          docker tag "$IMAGE_SHA" "$IMAGE_LATEST"

          echo "Push both tags"
          docker push "$IMAGE_SHA"
          docker push "$IMAGE_LATEST"

  # ───────────────────────────────
  # 2) CD: NCP self-hosted runner에서 배포
  # ───────────────────────────────
  deploy:
    needs: build-and-push
    runs-on: [self-hosted]    # config.sh에서 만든 runner 사용

    env:
      K8S_DEPLOYMENT: service-a
      K8S_CONTAINER: service-a
      IMAGE_SHA: ${{ needs.build-and-push.outputs.image_sha }}

    steps:
      - name: Show kubectl context
        run: |
          echo "Deploying image: $IMAGE_SHA"
          kubectl config current-context || echo "no current-context"
          kubectl get nodes

      - name: Rollout deployment
        run: |
          kubectl set image deployment/${K8S_DEPLOYMENT} \
            ${K8S_CONTAINER}=${IMAGE_SHA} --record
          kubectl rollout status deployment/${K8S_DEPLOYMENT}
